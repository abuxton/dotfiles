name: validate-dotfiles

on:
  push:
    branches: [main]
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout dotfiles to workspace
        uses: actions/checkout@v4
        with:
          path: dotfiles

      - name: Link dotfiles into home directory
        run: ln -sf "${GITHUB_WORKSPACE}/dotfiles" "${HOME}/dotfiles"

      - name: Run setup.sh
        run: bash "${HOME}/dotfiles/setup.sh"

      - name: Run bootstrap.sh
        run: bash "${HOME}/dotfiles/bootstrap.sh" --force

      - name: Verify dotfiles
        run: |
          echo "Verifying dotfiles are installed in home directory..."
          missing=0
          for file in .bash_profile .bashrc .aliases .functions .exports; do
            if [ -f "${HOME}/${file}" ]; then
              echo "✓ ${HOME}/${file} exists"
            else
              echo "✗ ${HOME}/${file} missing"
              missing=$((missing + 1))
            fi
          done
          if [ $missing -gt 0 ]; then
            echo "ERROR: $missing dotfile(s) are missing"
            exit 1
          fi
          echo "All dotfiles verified successfully!"
