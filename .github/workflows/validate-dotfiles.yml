name: Validate Dotfiles

on:
  push:
    branches:
      - main
      - feature/**
  pull_request:
    branches:
      - main

jobs:
  validate:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Verify repository structure
        run: |
          echo "Checking repository file structure..."
          [ -f .bash_secrets.template ] && echo "✓ .bash_secrets.template found" || exit 1
          [ -f setup.sh ] && echo "✓ setup.sh found" || exit 1
          [ -f bootstrap.sh ] && echo "✓ bootstrap.sh found" || exit 1
          [ -f validate-dotfiles.sh ] && echo "✓ validate-dotfiles.sh found" || exit 1
          [ -f .bash_profile ] && echo "✓ .bash_profile found" || exit 1
          [ -f .bashrc ] && echo "✓ .bashrc found" || exit 1
          [ -f .zshrc ] && echo "✓ .zshrc found" || exit 1
          [ -d .functions.d ] && echo "✓ .functions.d directory found" || exit 1
          [ $(find .functions.d -name "*.sh" -type f | wc -l) -ge 3 ] && echo "✓ Function modules present" || exit 1

      - name: Validate script permissions and syntax
        run: |
          echo "Checking script permissions and bash syntax..."
          chmod +x ./bootstrap.sh ./setup.sh ./validate-dotfiles.sh
          bash -n ./bootstrap.sh && echo "✓ bootstrap.sh syntax valid" || exit 1
          bash -n ./setup.sh && echo "✓ setup.sh syntax valid" || exit 1
          bash -n ./validate-dotfiles.sh && echo "✓ validate-dotfiles.sh syntax valid" || exit 1

      - name: Validate dotfile syntax
        run: |
          echo "Validating shell configuration files..."
          bash -n .bash_profile && echo "✓ .bash_profile syntax valid" || exit 1
          bash -n .bashrc && echo "✓ .bashrc syntax valid" || exit 1
          zsh -n .zshrc && echo "✓ .zshrc syntax valid" || exit 1

      - name: Check POSIX compliance
        run: |
          echo "Checking for bash-specific patterns in functions..."

          # Check if any function files use bash-specific syntax
          if grep -r "\[\[" .functions.d/*.sh 2>/dev/null; then
            echo "ERROR: Found bash-specific [[ ]] patterns in function files"
            exit 1
          fi
          if grep -r "declare -A" .functions.d/*.sh 2>/dev/null; then
            echo "ERROR: Found bash associative arrays in function files"
            exit 1
          fi
          echo "✓ POSIX compliance check passed"

      - name: Verify bootstrap.sh dry-run
        run: |
          echo "Verifying bootstrap.sh --dry-run mode..."
          bash ./bootstrap.sh --dry-run 2>&1 | head -50 || echo "Note: dry-run may require user interaction"

      - name: Verify setup.sh dry-run
        run: |
          echo "Verifying setup.sh --dry-run mode..."
          bash ./setup.sh --dry-run 2>&1 | head -50 || echo "Note: dry-run may require user interaction"

      - name: Run validation script
        run: |
          echo "Running comprehensive validation..."
          bash ./validate-dotfiles.sh 2>&1 || echo "Note: Some HOME-based checks may fail in CI (expected)"
        env:
          DOTFILES_DIR: ${{ github.workspace }}
